test_name "CVE-2013-3567 Arbitrary YAML Deserialization"

reportdir = master.tmpdir('yaml_deserialization')

dangerous_yaml = "--- !ruby/object:Puppet::Transaction::Report { metrics: { resources: !ruby/object:ERB { src: 'exit 0' } }, logs: [], resource_statuses: [], host: '$(puppet master --configprint certname)' }"

submit_bad_yaml = [
  "curl -k -X PUT",
  "--cacert $(puppet master --configprint cacert)",
  "--cert $(puppet master --configprint hostcert)",
  "--key $(puppet master --configprint hostprivkey)",
  "-H 'Content-Type: text/yaml'",
  "-d \"#{dangerous_yaml}\"",
  "\"https://#{master}:8140/production/report/$(puppet master --configprint certname)\""
].join(' ')

master_opts = {
  'master' => {
    'reportdir' => reportdir,
    'reports' => 'store',
  }
}

with_puppet_running_on(master, master_opts) do
  on master, submit_bad_yaml
  on master, "cat #{reportdir}/$(puppet master --configprint certname)/*" do
    assert_no_match(/ERB/, stdout, "Improperly propagated ERB object from input into puppet code")
  end
end

on master, "rm -rf #{reportdir}"
